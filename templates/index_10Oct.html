<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HireMe - User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Light blue/gray background */
        }
        input:required:invalid, select:required:invalid {
            border-color: #ef4444; /* Tailwind red-500 */
        }
        .full-screen-viewer {
            width: 100%;
            height: 600px; 
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
         /* Custom styles for the progress gauge */
        .progress-circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        /* Basic styling for the page */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        /* The main profile card container */
        .profile-card {
            background-color: #ffffff;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-width: 1000px;
            max-height: 1000px;
            width: 100%;
            height: 100%;
            padding: 24px 32px;
            border: 1px solid #e0e0e0;
        }

        /* Card Header */
        .profile-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1a237e; /* Dark blue color */
            margin: 0 0 8px 0;
        }
        
        .profile-headline {
            font-size: 16px;
            font-style: italic;
            color: #555;
            border-left: 3px solid #1a237e;
            padding-left: 12px;
            margin: 0 0 24px 0;
        }

        /* Grid layout for profile details */
        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        /* Each individual field */
        .profile-field {
            line-height: 1.5;
        }
        
        .profile-field .label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 4px;
        }

        .profile-field .value {
            font-size: 16px;
            color: #555;
        }
        
        /* Special styling for tags (Skills, Locations) */
        .profile-field .tag {
            display: inline-block;
            background-color: #e8eaf6; /* Light blue */
            color: #1a237e; /* Dark blue */
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 500;
            margin-right: 6px;
            margin-top: 4px;
        }

        /* Edit Profile Button */
        .profile-actions {
            text-align: right;
            border-top: 1px solid #eeeeee;
            padding-top: 20px;
            margin-top: 10px;
        }

        .edit-button {
            background-color: #3f51b5; /* Indigo color */
            color: #ffffff;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .edit-button:hover {
            background-color: #303f9f;
        }/* Form Container */
        .profile-form {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            padding: 24px 32px;
        }

        .profile-form h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1a237e;
            margin: 0 0 24px 0;
        }
        
        /* Form Group for each field */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        /* Standard Text Input */
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box; /* Ensures padding doesn't affect width */
        }

        /* Tag Input Styles */
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 6px;
            background-color: #fff;
            cursor: text;
        }
        .tag {
            display: flex;
            align-items: center;
            background-color: #3f51b5;
            color: white;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 14px;
        }
        .tag-remove {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .tag-container input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 6px;
            font-size: 16px;
            min-width: 150px;
        }
        .tag {
            display: inline-block;
            background-color: #28a745; /* Green background */
            color: white;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 16px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

  /* Styling for the container */
  #openforlocationcontainer {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen py-8">

    <div class="container mx-auto px-4 max-w-5xl space-y-8">
        
        <header class="flex justify-between items-center mb-6 p-4 bg-white rounded-2xl shadow-xl">
              <h1 class="text-4xl font-extrabold text-indigo-700 tracking-tight">HireMe Career Portal</h1>
              <button id="logoutBtn" onclick="logoutUser()" class="py-2 px-5 bg-red-600 text-white text-sm font-semibold rounded-full shadow-lg hover:bg-red-700 transition duration-300 hidden">
                Logout
            </button>
        </header>

        <div id="messageBox" class="p-4 bg-gray-100 rounded-lg text-center text-sm font-medium text-gray-600 shadow-inner">
            Checking authentication status...
        </div>

        <div id="authScreen" class="max-w-xl mx-auto space-y-10">
            <div class="p-8 text-center bg-indigo-50 rounded-xl border border-indigo-300 shadow-md">
                <h2 class="text-3xl font-bold text-indigo-700 mb-2">Login or Sign Up</h2>
                <p class="text-gray-600 text-lg">Access your profile and resume tools.</p>
            </div>

            <div id="loginContainer" class="p-8 border border-gray-200 rounded-xl bg-gray-50 space-y-6 shadow-lg">
                <h3 class="text-2xl font-bold text-gray-800">Log In</h3>
                <form id="loginForm" class="space-y-5">
                    <div>
                        <label for="loginUsername" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="loginUsername" name="user_name" placeholder="Enter your username" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm sm:text-base p-3 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="loginPassword" name="password" placeholder="Enter your password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm sm:text-base p-3 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="loginUserType" class="block text-sm font-medium text-gray-700">Select Role</label>
                        <select id="loginUserType" name="user_type" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm sm:text-base p-3" required>
                            <option value="JOB_SEEKER">Job Seeker</option>
                            <option value="RECRUITER">Company / Recruiter</option>
                            <option value="ADVERTISER">Advertiser</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-semibold text-white bg-indigo-600 hover:bg-indigo-700 transition duration-300">
                        Log In
                    </button>
                </form>

                
            </div>

            <div id="signupContainer" class="p-8 border border-green-300 rounded-xl bg-green-50 space-y-6 shadow-lg hidden">
                <h3 class="text-2xl font-bold text-green-700">New User Signup</h3>
                <form id="signupForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="signupUsername" name="user_name" placeholder="Username" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                        <input type="password" id="signupPassword" name="password" placeholder="Password" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                        <input type="text" id="signupFirstName" name="first_name" placeholder="First Name" class="mt-1 block w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm">
                        <input type="text" id="signupLastName" name="last_name" placeholder="Last Name" class="mt-1 block w-full px-3 py-3 border border-gray-300 rounded-lg shadow-sm">
                        <input type="tel" id="signupMobileNumber" name="mobile_number" placeholder="Mobile Number (Mandatory)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                        <input type="email" id="signupEmail" name="email" placeholder="Email (Mandatory)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                        <input type="date" id="signupDOB" name="date_of_birth" placeholder="Date of Birth" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                        <select id="signupUserType" name="user_type" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                            <option value="JOB_SEEKER">Sign up as Job Seeker</option>
                            <option value="RECRUITER">Sign up as Company</option>
                            <option value="ADVERTISER">Sign up as Advertiser</option>
                        </select>
                        <select id="signupMembership" name="membershipDays" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                            <option value="0">Free Trial (0 Days)</option>
                            <option value="15">Premium (15 Days)</option>
                            <option value="30">Premium (30 Days)</option>
                            <option value="90">Premium (90 Days)</option>
                            <option value="365">Premium (365 Days)</option>
                        </select>
                    </div>
                    <div id="companyFields" class="company-fields-group">
                            <input type="text" id="signupCompanyName" name="company_name" placeholder="Company Name (Required)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                        </div>
                        <div id="gstFields" class="company-fields-group">
                            <input type="text" id="signupGstNumber" name="gst_number" placeholder="GST / Registration ID (Required)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                        </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-semibold text-white bg-green-600 hover:bg-green-700 transition duration-300">
                        Sign Up & Log In
                    </button>
                </form>
            </div>
              <hr class="my-6 border-gray-300">

                  <div class="text-center">
                      <p class="text-sm text-gray-600 mb-3">Don't have an account?</p>
                      <button type="button" id="toggleSignupBtn" class="py-2 px-6 border border-green-600 text-sm font-semibold rounded-full text-green-600 hover:bg-green-100 transition duration-300">
                          Show Signup Form
                      </button>
            </div>
        </div>

        <div id="dashboardScreen" class="space-y-8 hidden">
            
            <div class="p-8 text-center bg-white rounded-2xl border shadow-xl" id="dashboardHeader">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-2" id="dashboardTitle"></h2>
                <p class="text-gray-600 text-lg mb-2" id="dashboardSubtitle"></p>
                <div class="flex justify-center items-center space-x-4 mt-2">
                    <p class="text-sm font-medium text-indigo-600">User: <span id="currentUsernameDisplay" class="font-bold"></span></p>
                    <span id="paidStatusBadge" class="px-3 py-1 text-xs font-bold rounded-full"></span>
                </div>
            </div>

            <div id="dashboardContent" class="space-y-8">
                </div>
        </div>

    </div>

    <script>
        const API_URL = 'http://localhost:8080';
        
        // --- GLOBAL STATE ---
        let currentUserId = localStorage.getItem('currentUserId') ? parseInt(localStorage.getItem('currentUserId')) : null;
        let currentUsername = localStorage.getItem('currentUsername') || null;
        let currentUserRole = localStorage.getItem('currentUserRole') || null;
        let currentMembershipDays = parseInt(localStorage.getItem('currentMembershipDays')) || 0;
        let currentIsPaidMember = currentMembershipDays > 0;

        // State for Job Seeker Profile (Simulated)
        let jobSeekerProfile = null; 
        let isProfileComplete = false;


        // Global state to hold the uploaded file data for immediate analysis (for Job Seeker)
        window.lastUploadedBase64 = null;
        window.lastUploadedMimeType = null;

        const messageBox = document.getElementById('messageBox');
        const logoutBtn = document.getElementById('logoutBtn');
        const authScreen = document.getElementById('authScreen');
        const dashboardScreen = document.getElementById('dashboardScreen');
        const signupContainer = document.getElementById('signupContainer');
        const loginContainer = document.getElementById('loginContainer');
// Global Message Function
        function showMessage(text, type = 'info') {
             // Set a timeout to hide the message after 4 seconds
            messageTimeout = setTimeout(() => {
                messageBox.textContent = ''; // Clear text
                // Reset to default neutral state
                messageBox.className = 'p-4 bg-gray-100 rounded-lg text-center text-sm font-medium text-gray-600 shadow-inner';
            }, 4); // 4 seconds
            // Clear any existing timeout
            clearTimeout(messageTimeout);

            messageBox.textContent = text;
            messageBox.className = 'p-4 rounded-lg text-center text-sm font-medium shadow-inner'; // Reset classes
            
            if (type === 'success') messageBox.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'error') messageBox.classList.add('bg-red-100', 'text-red-800');
            else messageBox.classList.add('bg-blue-100', 'text-blue-800');

           
        };
        
        // --- CORE AUTH AND STATE MANAGEMENT ---

        function updateDashboardHeader(role, isPaid, days) {
            const titleElement = document.getElementById('dashboardTitle');
            const subtitleElement = document.getElementById('dashboardSubtitle');
            const badgeElement = document.getElementById('paidStatusBadge');

            document.getElementById('currentUsernameDisplay').textContent = currentUsername;

            badgeElement.classList.remove('bg-green-600', 'text-white', 'bg-gray-200', 'text-gray-700');

            if (isPaid && days > 0) {
                badgeElement.textContent = `PREMIUM ACCESS (${days} Days)`;
                badgeElement.classList.add('bg-green-600', 'text-white');
            } else {
                badgeElement.textContent = `FREE TIER`;
                badgeElement.classList.add('bg-gray-200', 'text-gray-700');
            }

            switch (role) {
                case 'JOB_SEEKER':
                    titleElement.textContent = "Manage your resume and track profile activity."
                    loadJobSeekerDashboard();
                    break;
                case 'RECRUITER':
                    titleElement.textContent = "Recruiter Dashboard";
                    subtitleElement.textContent = "Manage job listings and search candidates.";
                    loadCompanyDashboard();
                    break;
                case 'ADVERTISER':
                    titleElement.textContent = "Advertiser Console";
                    subtitleElement.textContent = "Manage campaigns and monitor performance.";
                    loadAdvertiserDashboard();
                    break;
                default:
                    titleElement.textContent = "Welcome";
                    subtitleElement.textContent = "Access Denied: Unknown role.";
                    document.getElementById('dashboardContent').innerHTML = `<p class="text-center text-red-500">Access role not recognized.</p>`;
            }
        }
        
        function checkAuth() {
            if (currentUserId && currentUsername && currentUserRole) {
                authScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                
                // Initialize Dashboard based on role
                updateDashboardHeader(currentUserRole, currentIsPaidMember, currentMembershipDays);
                showMessage(`Welcome back, ${currentUsername}!`, 'success');
            } else {
                authScreen.classList.remove('hidden');
                dashboardScreen.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                 // FIX: Ensure login is visible and signup is hidden when starting logged out
                if (loginContainer && signupContainer) {
                    loginContainer.classList.remove('hidden');
                    signupContainer.classList.add('hidden');
                    // Ensure the button text reflects the state
                    document.getElementById('toggleSignupBtn').textContent = 'Show Signup Form';
                }
                
                showMessage('Please sign up or log in to continue.', 'info');
            }
        }

        function loginUser(id, username, role, isPaid, membershipDays,companyId) {
            console.log('Logging in user:', {id, username, role, isPaid, membershipDays});
            if (isNaN(parseInt(id)) || parseInt(id) <= 0) return showMessage('Invalid User ID provided.', 'error');
            
            localStorage.setItem('currentUserId', id);
            localStorage.setItem('currentUsername', username);
            localStorage.setItem('currentUserRole', role);
            localStorage.setItem('currentMembershipDays', membershipDays);
            localStorage.setItem('currentCompanyId',companyId);

            currentUserId = id;
            currentUsername = username;
            currentUserRole = role;
            currentMembershipDays = membershipDays;
            currentIsPaidMember = isPaid;

            showMessage(`Welcome back, ${username} (${role})! Logged in successfully.`, 'success');
            checkAuth();
        }

        function logoutUser() {
            localStorage.clear();
            currentUserId = null;
            currentUsername = null;
            currentUserRole = null;
            currentIsPaidMember = false;
            currentMembershipDays = 0;
            // Clear local file state
            window.lastUploadedBase64 = null;
            window.lastUploadedMimeType = null;
             // Reset profile state on logout
            jobSeekerProfile = null;
            isProfileComplete = false;
            checkAuth();
        }

        function toggleSignupFields(role) {
            const isCompanyOrAdvertiser = (role === 'RECRUITER' || role === 'ADVERTISER');
            
            const companyFields = document.getElementById('companyFields');
            const gstFields = document.getElementById('gstFields');
            const companyNameInput = document.getElementById('signupCompanyName');
            const gstNumberInput = document.getElementById('signupGstNumber');
            
            // Toggle Visibility
            companyFields.style.display = isCompanyOrAdvertiser ? 'block' : 'none';
            gstFields.style.display = isCompanyOrAdvertiser ? 'block' : 'none';
            
            // Toggle Mandatory Status (The required attribute is crucial for browser validation)
            companyNameInput.required = isCompanyOrAdvertiser;
            gstNumberInput.required = isCompanyOrAdvertiser;
            
            // Ensure inputs are cleared if they are hidden to avoid sending invalid data
            if (!isCompanyOrAdvertiser) {
                 companyNameInput.value = '';
                 gstNumberInput.value = '';
            }
        }
        // Attach field toggle listener on load
        document.addEventListener('DOMContentLoaded', () => {
            const signupUserTypeSelect = document.getElementById('signupUserType');
            if (signupUserTypeSelect) {
                signupUserTypeSelect.addEventListener('change', (e) => toggleSignupFields(e.target.value));
                // Initial check
                toggleSignupFields(signupUserTypeSelect.value);
            }
            checkAuth();
        });


        function toggleSignupForm() {
            const isHidden = signupContainer.classList.contains('hidden');
            
            // Toggle visibility of the signup form container
            signupContainer.classList.toggle('hidden', !isHidden);
            
            // Toggle visibility of the login form container (The FIX)
            loginContainer.classList.toggle('hidden', isHidden); 
            
            document.getElementById('toggleSignupBtn').textContent = isHidden ? 'Hide Signup Form' : 'Show Signup Form';
            
            // Reset fields on toggle
            document.getElementById('signupForm').reset();
            toggleSignupFields('JOB_SEEKER'); // Default to hiding company fields
        }

        document.getElementById('toggleSignupBtn').addEventListener('click', toggleSignupForm);
        
        // --- API HANDLERS (Simplified for Monolithic File) ---

        // Helper Function to get form data
        function getAuthFormData(formId) {
            const form = document.getElementById(formId);
            const data = {};
            new FormData(form).forEach((value, key) => {
                data[key] = value.trim();
            });
            return data;
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessage('Attempting login...', 'info');
            const user_name = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const user_type = document.getElementById('loginUserType').value; // Get selected role

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_name: user_name, password: password, user_type: user_type })
                });
                const data = await response.json();

                if (response.ok) {
                    const simulatedMembership = (user_name === 'premium_recruiter' && user_type === 'RECRUITER') ? 90 : 0;
                    
                    const backendData = {
                        user_id: data.user_id || 101, 
                        user_name: user_name,
                        user_type: user_type, 
                        is_paid_member: (simulatedMembership > 0),
                        membership_days: simulatedMembership,
                        

                    };
                    var companyId=""
                    if (user_type === 'RECRUITER'){
                        companyId=data.company_id
                    }
                    

                    loginUser(backendData.user_id, backendData.user_name, backendData.user_type, backendData.is_paid_member, backendData.membership_days,companyId||"");
                } else {
                    showMessage(`Login Error: ${data.message || 'Invalid credentials or server error.'}`, 'error');
                }
            } catch (error) {
                console.error('Login failed:', error);
                showMessage('Network error during login. Check Go server and CORS.', 'error');
            }
        });

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessage('Signing up user...', 'info');
            const requestBody = getAuthFormData('signupForm');
            
            const user_type = document.getElementById('signupUserType').value;
            const membershipDays = parseInt(document.getElementById('signupMembership').value);
            if ((user_type === 'RECRUITER' || user_type === 'ADVERTISER') && (!requestBody.company_name || !requestBody.gst_number)) {
                showMessage('Company Name and GST/Registration ID are required for this role.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();

                if (response.ok) {
                    const isPaid = membershipDays > 0;
                    var companyId='';
                    if (user_type=='RECRUITER'){
                        companyId=data.company_id;
                    }
                    loginUser(data.user_id, requestBody.user_name, user_type, isPaid, membershipDays,companyId||'');
                } else {
                    showMessage(`Signup Error: ${data.message || 'Failed to sign up. Username or email may be taken.'}`, 'error');
                }
            } catch (error) {
                console.error('Signup failed:', error);
                showMessage('Network error during signup. Check Go server and CORS.', 'error');
            }
        });

        // --- RESUME UPLOAD/ANALYSIS LOGIC (Used by Job Seeker Dashboard) ---
        async function updateDashboardResumeSection(userID) {
            // --- Get UI element references ---
            const statusSpan = document.getElementById('currentResumeStatus');
            const infoDiv = document.getElementById('currentResumeInfo');
            const analyzeBtn = document.getElementById('analyzeResumeBtn');
            const viewerContainer = document.getElementById('resumeViewerContainer');
            const aiStatusSpan = document.getElementById('aiStatus');
            const resultsContainer = document.getElementById('results');
            const overallScoreEl = document.getElementById('overall-score');
            const ratingLabelEl = document.getElementById('rating-label');
            const progressCircle = document.getElementById('progress-circle');
            const contactEmailEl = document.getElementById('contact-email');
            const contactPhoneEl = document.getElementById('contact-phone');
            const skillsTableBody = document.getElementById('skills-table-body');
            // --- Basic validation ---
            if (!userID || !statusSpan) return;

            // --- Reset UI to a loading state ---
            statusSpan.textContent = "Checking...";
            statusSpan.classList.remove('text-green-600', 'text-red-600'); // Reset color
            analyzeBtn.disabled = true;
            infoDiv.classList.add('hidden');
            viewerContainer.classList.add('hidden');
            aiStatusSpan.textContent = "Status: Contacting server...";


            try {
                const response = await fetch(`${API_URL}/resume/${userID}`);

                // --- Case 1: Successful response (HTTP 2xx) ---
                if (response.ok) {
                    const data = await response.json();
                    statusSpan.textContent = "Uploaded";
                    statusSpan.classList.add('text-green-600');
                    document.getElementById('currentFilenameSummary').textContent = data.filename;
                    document.getElementById('currentUploadTimeSummary').textContent = data.uploaded_at ? new Date(data.uploaded_at).toLocaleDateString() : 'N/A';
                    
                    infoDiv.classList.remove('hidden');
                    const response1 = await fetch(`${API_URL}/analyze-resume/${userID}`);
                    if(response1.ok){
                        const analysisData = await response1.json();
                        if(analysisData === ""){
                            analyzeBtn.disabled = false;
                            aiStatusSpan.textContent = "Resume Uploaded, Not Analyzed Yet.";
                        } else {
                            analyzeBtn.classList.add('hidden');
                            aiStatusSpan.textContent = "Status: Analysis Completed.";
                    // Populate UI with data
                    console.log('Analysis Data:', analysisData);
                    displayOverallRating(analysisData.overallRating, overallScoreEl, ratingLabelEl, progressCircle);
                    displayContactInfo(analysisData.contactInfo, contactEmailEl, contactPhoneEl);
                    displaySkills(analysisData.skills, skillsTableBody);
                    resultsContainer.classList.remove('hidden');
                        }
                    } else {
                        aiStatusSpan.textContent = "Status: Unable to fetch analysis status.";
                        analyzeBtn.disabled = false;
                    }

                    const downloadUrl = API_URL + data.download_url;
                    
                    // Setup button event handlers
                    document.getElementById('viewResumeBtn').onclick = () => {
                        const viewer = document.getElementById('resumeViewer');
                        const isHidden = viewerContainer.classList.contains('hidden');
                        if (isHidden) {
                            viewer.src = downloadUrl;
                            viewerContainer.classList.remove('hidden');
                            document.getElementById('viewResumeBtn').textContent = 'Hide Preview';
                        } else {
                            viewerContainer.classList.add('hidden');
                            viewer.src = '';
                            document.getElementById('viewResumeBtn').textContent = 'View Resume in Browser';
                        }
                    };
                    document.getElementById('downloadResumeBtn').onclick = () => window.open(downloadUrl, '_blank');

                } else {
                    // --- Case 2: Server responded, but with an error status ---
                    
                    // Specifically handle 404 Not Found - this is an expected "error"
                    if (response.status === 404) {
                        statusSpan.textContent = "Not Uploaded";
                        aiStatusSpan.textContent = "Status: Awaiting upload.";
                        document.getElementById('currentFilenameSummary').textContent = "None";
                        document.getElementById('currentUploadTimeSummary').textContent = "N/A";
                    } else {
                        // Handle all other server errors (500, 403, etc.)
                        statusSpan.textContent = "Server Error";
                        aiStatusSpan.textContent = `Status: Error (${response.status})`;
                        // For debugging, log the specific error
                        console.error('Server responded with an error:', response.status, response.statusText);
                        showMessage(`Could not retrieve resume info. Server returned status: ${response.status}`, 'error');
                    }
                    statusSpan.classList.add('text-red-600');
                }
            } catch (error) {
                // --- Case 3: Network error or fetch failed completely ---
                // This block runs if the server is unreachable (e.g., network down, CORS error)
                console.error('Resume status check failed:', error);
                statusSpan.textContent = "Connection Error";
                statusSpan.classList.add('text-red-600');
                aiStatusSpan.textContent = "Status: Cannot connect to API.";
                showMessage('Could not connect to the resume API. Please check your network connection.', 'error');
            }
        }

        window.handleResumeUpload = async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('resumeFile');
            const file = fileInput.files[0];
            
            if (!file || !currentUserId) return showMessage('Select a file.', 'error');
            if (file.size > 4 * 1024 * 1024) return showMessage('File size limit is 4MB.', 'error');

            window.lastUploadedBase64 = null;
            window.lastUploadedMimeType = null;

            const reader = new FileReader();
            reader.onload = async function (event) {
                const base64Uri = event.target.result;
                
                const payload = {
                    user_id: parseInt(currentUserId),
                    filename: file.name,
                    mime_type: file.type,
                    base64_data: base64Uri
                };

                showMessage('Uploading resume to server...', 'info');
                try {
                    const response = await fetch(`${API_URL}/resume/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        showMessage(`Resume uploaded successfully!`, 'success');
                        updateDashboardResumeSection(currentUserId);
                        fileInput.value = '';
                    } else {
                        const data = await response.json();
                        showMessage(`Upload failed: ${data.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    console.error('Resume Upload API Error:', error);
                    showMessage('Network error during upload.', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        // --- Job Seeker Profile Functions ---
        async function fetchUserProfile(userId) {
            if (!userId) {
                isProfileComplete = false;
                jobSeekerProfile = null;
                return;
            }
            try {
                const response = await fetch(`${API_URL}/jobseeker/profile/${userId}`);
                if (response.ok) {
                    const data = await response.json();
                    jobSeekerProfile = data;
                    jobSeekerProfile.allCurrentSkills=data.skills;
                    isProfileComplete = true;
                } else {
                    jobSeekerProfile = null;
                    isProfileComplete = false;
                }
            } catch (error) {
                jobSeekerProfile = null;
                isProfileComplete = false;
            }finally {
                console.log('Fetched profile:', jobSeekerProfile);
            }
        }

        function renderProfileSection() {
            const promptContainer = document.getElementById('profilePromptContainer');
            const detailsContainer = document.getElementById('profileDetailsContainer');
            const formContainer = document.getElementById('profileUpdateFormContainer');

            if (isProfileComplete && jobSeekerProfile) {
                promptContainer.classList.add('hidden');
                formContainer.classList.add('hidden');
                detailsContainer.classList.remove('hidden');

                detailsContainer.innerHTML = `
                    <div class=" text-sm text-gray-700">
                        <div class="profile-header">
                                <h2>Your Professional Profile</h2>
                                <p class="profile-headline">"${jobSeekerProfile.profile_summary || 'No headline provided'}"</p>
                            </div>
                       <div class="profile-card">
                            <div class="profile-details">
                                <div class="profile-field">
                                    <span class="label">Job Title</span>
                                    <span class="value">${jobSeekerProfile.job_title || 'N/A'}</span>
                                </div>
                                <div class="profile-field">
                                    <span class="label">Current Company</span>
                                    <span class="value">${jobSeekerProfile.current_company || 'N/A'}</span>
                                </div>
                                <div class="profile-field">
                                    <span class="label">Current Location</span>
                                    <span class="value">${jobSeekerProfile.location || 'N/A'}</span>
                                </div>
                                <div class="profile-field">
                                    <span class="label">Overall Experience</span>
                                    <span class="value">${jobSeekerProfile.overall_work_ex ? `${jobSeekerProfile.overall_work_ex} Years` : 'N/A'}</span>
                                </div>
                                <div class="profile-field">
                                    <span class="label">Experience in Role</span>
                                    <span class="value">${jobSeekerProfile.work_ex ? `${jobSeekerProfile.work_ex} Years` : 'N/A'}</span>
                                </div>
                                <div class="profile-field">
                                    <span class="label">Expected Salary</span>
                                    <span class="value">${jobSeekerProfile.salary_range ? `â‚¹${jobSeekerProfile.salary_range} LPA` : 'N/A'}</span>
                                </div>
                                <div class="profile-field">
                                    <span class="label">Job Type</span>
                                    <span class="value">${jobSeekerProfile.job_type || 'N/A'}</span>
                                </div>
                                <div class="profile-field">
                                    <span class="label">Job Type</span>
                                    <span class="value">${jobSeekerProfile.job_title || 'N/A'}</span>
                                </div>
                                <div>
                                 </div>   
                                <div>
                                <div class="profile-field">
                                    <span class="label">Open For Locations</span>
                                    <div id="openforlocationcontainer"></div>
                                </div>
                                <div class="profile-field">
                                    <span class="label">Skills</span>
                                    <div id="allCurrentSkills"></div>
                                </div>
                                </div>
                                <div class="profile-field">
                                    <span class="label">Additional Details</span>
                                    <p class="value">${jobSeekerProfile.details || 'N/A'}</p>
                                </div>
                            </div>

                           
                    </div>
                    <button id="editProfileBtn" class="mt-4 py-2 px-5 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                        Edit Profile
                    </button> 
                `;
                document.getElementById('editProfileBtn').addEventListener('click', () => toggleProfileForm(true));
                // 1. Your dynamically generated dataset
                const optedOpenForLocationData = jobSeekerProfile.open_for_locations || '';

                // 2. Get the container element from the HTML
                const container = document.getElementById('openforlocationcontainer');

                // 3. Split the string into an array of location names
                const optedOpenForLocationArray = optedOpenForLocationData.split(',');

                // 4. Loop through the array and create an HTML element for each location
                optedOpenForLocationArray.forEach(location => {
                    // Trim whitespace from the location name
                    const locationName = location.trim(); 
                    
                    // Create a new <span> element
                    const tagElement = document.createElement('span');
                    
                    // Add the "tag" class for styling
                    tagElement.classList.add('tag');
                    
                    // Set the text inside the <span> to the location name
                    tagElement.textContent = locationName;
                    
                    // Append the newly created tag to the container
                    container.appendChild(tagElement);
                });

                 const optedSkillsData = jobSeekerProfile.allCurrentSkills || 'No skills listed';

                // 2. Get the container element from the HTML
                const skillContainer = document.getElementById('allCurrentSkills');

                // 3. Split the string into an array of location names
                const optedSkillsArray = optedSkillsData.split(',');

                // 4. Loop through the array and create an HTML element for each location
                optedSkillsArray.forEach(skill => {
                    // Trim whitespace from the location name
                    const skillName = skill.trim(); 
                    
                    // Create a new <span> element
                    const tagElement = document.createElement('span');
                    
                    // Add the "tag" class for styling
                    tagElement.classList.add('tag');
                    
                    // Set the text inside the <span> to the location name
                    tagElement.textContent = skillName;
                    
                    // Append the newly created tag to the container
                    skillContainer.appendChild(tagElement);
                });
            } else {
                detailsContainer.classList.add('hidden');
                formContainer.classList.add('hidden');
                promptContainer.classList.remove('hidden');
            }
        }

        function toggleProfileForm(show) {
            const tagContainer = document.getElementById('locations-container');
            const textInput = document.getElementById('locations-input');
            const hiddenInput = document.getElementById('hidden-locations');
            let locations = [];
            const formContainer = document.getElementById('profileUpdateFormContainer');
            const promptContainer = document.getElementById('profilePromptContainer');
            const detailsContainer = document.getElementById('profileDetailsContainer');
            
            if (show) {
                promptContainer.classList.add('hidden');
                detailsContainer.classList.add('hidden');
                formContainer.classList.remove('hidden');

                // Pre-fill form if data exists
                if(jobSeekerProfile) {
                    document.getElementById('profileSummary').value = jobSeekerProfile.profile_summary || '';
                    document.getElementById('profileLocation').value = jobSeekerProfile.location || '';
                    document.getElementById('profileCurrentCompany').value = jobSeekerProfile.current_company || '';
                    document.getElementById('hidden-locations').value = jobSeekerProfile.open_for_locations || '';
                    document.getElementById('profileSalaryRange').value = jobSeekerProfile.salary_range || '';
                    document.getElementById('profileWorkEx').value = jobSeekerProfile.work_ex || '';
                    document.getElementById('profileOverallWorkEx').value = jobSeekerProfile.overall_work_ex || '';
                    document.getElementById('allcurrentskill').value = jobSeekerProfile.skills || '';
                    document.getElementById('profileJobType').value = jobSeekerProfile.job_type || '';
                    document.getElementById('profileJobTitle').value = jobSeekerProfile.job_title || '';
                    document.getElementById('profileDetails').value = jobSeekerProfile.details || '';

                }
            } else {
                formContainer.classList.add('hidden');
                renderProfileSection(); // Re-render to show correct state
            }
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            showMessage('Saving profile...', 'info');

            const formData = new FormData(e.target);
            const updatedProfile = {
                user_id: currentUserId,
                profile_summary: formData.get('profile_summary'),
                location: formData.get('location'),
                current_company: formData.get('current_company'),
                open_for_locations: formData.get('open_for_locations'),
                salary_range: formData.get('salary_range'),
                work_ex: formData.get('work_ex'),
                overall_work_ex: formData.get('overall_work_ex'),
                skills: formData.get('skill-overall'),
                job_type: formData.get('job_type'),
                job_title: formData.get('job_title'),
                details: formData.get('details')
            };

            try {
                const response = await fetch(`${API_URL}/jobseeker/profile/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedProfile)
                });
                const data = await response.json();

                if (response.ok) {
                    // Simulation: save to localStorage
                    localStorage.setItem(`profile_${currentUserId}`, JSON.stringify(updatedProfile));
                    jobSeekerProfile = updatedProfile;
                    isProfileComplete = true;
                    showMessage('Profile updated successfully!', 'success');
                    renderProfileSection();
                } else {
                    showMessage(`Profile update failed: ${data.message || 'Unknown error.'}`, 'error');
                }
            } catch (error) {
                showMessage('Network error during profile update.', 'error');
            }
        }

        // --- DASHBOARD LOADERS (Defined in window scope for global access) ---

        window.loadJobSeekerDashboard = async function() {
            const content = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
                         <div class="p-6 bg-yellow-50 rounded-xl border border-yellow-300 shadow-md">
                            <h3 class="text-xl font-bold text-yellow-700 mb-3 flex items-center">Resume Status</h3>
                            <div id="resumeStatusContent" class="text-sm text-gray-600 space-y-2">
                                <p>Status: <span id="currentResumeStatus" class="font-bold text-red-600">Not Uploaded</span></p>
                                <p>File: <span id="currentFilenameSummary">N/A</span></p>
                                <p>Last Update: <span id="currentUploadTimeSummary">N/A</span></p>
                            </div>
                        </div>

                        <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-md">
                            <h3 class="text-xl font-bold text-gray-700 mb-3 flex items-center">Total Profile Views</h3>
                            <p class="text-5xl font-extrabold text-green-600">
                                <span id="companyViewProfileCount">0</span>
                            </p>

                            <ul id="companyVisitList" class="text-sm text-gray-600 mt-4 space-y-2">
                                </ul>
                        </div>
                        <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-md">
                            <h3 class="text-xl font-bold text-gray-700 mb-3 flex items-center">Applications Sent</h3>
                            <p class="text-5xl font-extrabold text-blue-600"><span id="companyAppliedCount">5</span></p>
                            <p class="text-sm text-gray-500 mt-2">Jobs you applied to this month (Simulated).</p>
                        </div>
                    </div>
                   
                    <div id="aiAnalyzerSection" class="lg:col-span-3 p-6 bg-gray-900 rounded-2xl shadow-xl border border-indigo-400/50 space-y-4">
                         <h3 class="text-2xl font-bold text-white border-b border-gray-700 pb-3 text-center">AI Resume Analysis</h3>
                        <div class="text-center">
                            <p class="font-medium text-gray-400 mb-3" id="aiStatus">Status: Upload a resume to enable analysis.</p>
                            <button id="analyzeResumeBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Analyze Uploaded Resume
                            </button>
                        </div>

                        <!-- Loading Spinner -->
                        <div id="loader" class="hidden flex justify-center items-center my-8">
                            <svg class="animate-spin h-10 w-10 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>

                        <!-- Error Message -->
                        <div id="error-container" class="hidden bg-red-900 border border-red-600 text-red-200 px-4 py-3 rounded-lg relative my-4" role="alert">
                            <strong class="font-bold">Error:</strong>
                            <span class="block sm:inline" id="error-message"></span>
                        </div>
                        
                        <!-- Results Container -->
                        <div id="results" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
                            <!-- Overall Rating -->
                            <div class="md:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center">
                                <h2 class="text-xl font-semibold text-white mb-4">Overall Match</h2>
                                <div class="relative w-40 h-40">
                                    <svg class="w-full h-full" viewBox="0 0 36 36">
                                        <path class="text-gray-700" stroke-width="3" stroke="currentColor" fill="none"
                                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                        <path id="progress-circle" class="progress-circle text-indigo-500" stroke-width="3" stroke-linecap="round" stroke="currentColor" fill="none"
                                            stroke-dasharray="100, 100" stroke-dashoffset="100"
                                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    </svg>
                                    <div id="overall-score" class="absolute inset-0 flex flex-col items-center justify-center text-white text-3xl font-bold">
                                        0%
                                    </div>
                                </div>
                                <p id="rating-label" class="mt-4 text-lg font-medium text-gray-300"></p>
                            </div>

                            <!-- Skills & Contact -->
                            <div class="md:col-span-2 bg-gray-800 p-6 rounded-2xl shadow-lg text-gray-200">
                                <!-- Contact Info -->
                                <div class="mb-6">
                                    <h2 class="text-xl font-semibold text-white mb-3">Contact Information</h2>
                                    <div class="flex items-center text-gray-300 mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-indigo-400" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                                        <span id="contact-email"></span>
                                    </div>
                                    <div class="flex items-center text-gray-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-indigo-400" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.518.76a11.042 11.042 0 005.462 5.462l.76-1.518a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg>
                                        <span id="contact-phone"></span>
                                    </div>
                                </div>
                                
                                <!-- Skills Breakdown -->
                                <div>
                                    <h2 class="text-xl font-semibold text-white mb-3">Skills Breakdown</h2>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full text-left text-sm font-light">
                                            <thead class="border-b border-gray-600 font-medium">
                                                <tr>
                                                    <th scope="col" class="px-4 py-3">Skill</th>
                                                    <th scope="col" class="px-4 py-3 text-center">Mentions</th>
                                                    <th scope="col" class="px-4 py-3">Rating</th>
                                                </tr>
                                            </thead>
                                            <tbody id="skills-table-body">
                                                <!-- JS will populate this -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-8 border-gray-200">

                <div id="jobSeekerProfileSection" class="p-8 bg-white rounded-2xl shadow-xl border border-blue-400/50 space-y-6">
                    
                    <div id="profilePromptContainer">
                        <button id="toggleProfileFormBtn" class="w-full text-left p-4 bg-blue-100 rounded-lg text-blue-800 font-semibold hover:bg-blue-200 transition duration-300">
                            âž¡ï¸ Complete your profile to increase visibility to recruiters.
                        </button>
                    </div>

                    <div id="profileDetailsContainer" class="hidden">
                        </div>

                    <div id="profileUpdateFormContainer" class="hidden">
                        <form id="jobSeekerProfileForm" class="space-y-4 p-5 border border-blue-200 rounded-xl bg-blue-50 shadow-inner">
                            <h4 class="text-xl font-semibold text-gray-700">Update Your Details</h4>
                            <!-- UserId (readonly, hidden for user, but included for backend) -->
                            <input type="hidden" id="profileUserId" name="user_id" value="">
                             <div>
                                <label for="profileSummary" class="block text-sm font-medium text-gray-700">Professional Headline</label>
                                <input type="text" id="profileSummary" name="profile_summary" placeholder="e.g., Senior Software Engineer" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                            </div>
                            <div>
                                <label for="profileLocation" class="block text-sm font-medium text-gray-700">Current Location</label>
                                <input type="text" id="profileLocation" name="location" placeholder="e.g., Gurugram, India" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                            </div>
                            <div>
                                <label for="profileCurrentCompany" class="block text-sm font-medium text-gray-700">Current Company</label>
                                <input type="text" id="profileCurrentCompany" name="current_company" placeholder="e.g., Google" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                            </div>
                            <div class="form-group">
                                <label for="locations-input">Open For Locations</label>
                                <div class="tag-container" id="locations-container">
                                    <input type="text" id="locations-input" placeholder="Add another location...">
                                </div>
                                <input type="hidden" name="open_for_locations" id="hidden-locations" value="Pune,Gurugram">
                            </div>
                            <div>
                                <label for="profileSalaryRange" class="block text-sm font-medium text-gray-700">Current Annual Package</label>
                                <input type="text" id="profileSalaryRange" name="salary_range" placeholder="e.g., 10-15 Lacs" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                            </div>
                            <div>
                                <label for="profileWorkEx" class="block text-sm font-medium text-gray-700">Work Experience (Current Role)</label>
                                <input type="text" id="profileWorkEx" name="work_ex" placeholder="e.g., 3 years" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                            </div>
                            <div>
                                <label for="profileOverallWorkEx" class="block text-sm font-medium text-gray-700">Overall Work Experience</label>
                                <input type="text" id="profileOverallWorkEx" name="overall_work_ex" placeholder="e.g., 8 years" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                            </div>
                            <div class="form-group">
                                <label for="skills-input">Skills</label>
                                <div class="tag-container" id="skills-container">
                                    <input type="text" id="skills-input" placeholder="Add another location...">
                                </div>
                                <input type="hidden" name="skill-overall" id="hidden-skills" value="Java,Python,SQL">
                            </div>
                            <div>
                                <label for="profileJobType" class="block text-sm font-medium text-gray-700">Job Type</label>
                                <input type="text" id="profileJobType" name="job_type" placeholder="e.g., Full Time" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                            </div>
                            <div>
                                <label for="profileJobTitle" class="block text-sm font-medium text-gray-700">Job Title</label>
                                <input type="text" id="profileJobTitle" name="job_title" placeholder="e.g., Software Engineer" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                            </div>
                            <div>
                                <label for="profileDetails" class="block text-sm font-medium text-gray-700">Details</label>
                                <textarea id="profileDetails" name="details" rows="4" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"></textarea>
                            </div>
                            <div class="flex space-x-4 pt-2">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-150">Save Profile</button>
                                <button type="button" id="cancelProfileUpdateBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-5 rounded-lg shadow-sm">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="resumeManagerSection" class="p-8 bg-white rounded-2xl shadow-xl border border-yellow-400/50 space-y-6">
                    <h3 class="text-2xl font-bold text-yellow-800 border-b pb-3 flex items-center">Resume Upload & Viewer</h3>
                    
                    <div id="currentResumeInfo" class="space-y-4 p-5 border border-gray-200 rounded-xl bg-white shadow-sm hidden">
                        <h4 class="text-xl font-semibold text-gray-700">Preview & Download</h4>
                        <div class="flex space-x-4">
                            <button id="viewResumeBtn" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-150">View Resume in Browser</button>
                            <button id="downloadResumeBtn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-md transition duration-150">Download File</button>
                        </div>
                    </div>
                    
                    <form id="resumeUploadForm" class="space-y-4 p-5 border border-yellow-200 rounded-xl bg-yellow-50 shadow-inner">
                        <h4 class="text-xl font-semibold text-gray-700">Upload New Resume (.PDF, .DOC, .DOCX)</h4>
                        <label for="resumeFile" class="block text-sm font-medium text-gray-700">Select File (Max 4MB):</label>
                        <input type="file" id="resumeFile" accept=".pdf,.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-lg shadow-sm">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md transition duration-150">
                            Upload & Replace Current Resume
                        </button>
                    </form>

                    <div id="resumeViewerContainer" class="hidden">
                        <p class="text-sm font-medium text-gray-700 mb-2">Resume Preview (Streamed from Server):</p>
                        <embed id="resumeViewer" src="" class="full-screen-viewer" type="application/pdf">
                    </div>
                </div>
            `;
            document.getElementById('dashboardContent').innerHTML = content;

            // --- Attach listeners for the dashboard ---
            document.getElementById('resumeUploadForm').addEventListener('submit', window.handleResumeUpload);
            
            // --- Attach listeners for the AI Analyzer ---
            const analyzeBtn = document.getElementById('analyzeResumeBtn');
            const loader = document.getElementById('loader');
            const resultsContainer = document.getElementById('results');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            const overallScoreEl = document.getElementById('overall-score');
            const ratingLabelEl = document.getElementById('rating-label');
            const progressCircle = document.getElementById('progress-circle');
            const contactEmailEl = document.getElementById('contact-email');
            const contactPhoneEl = document.getElementById('contact-phone');
            const skillsTableBody = document.getElementById('skills-table-body');
            
            const tagContainer = document.getElementById('locations-container');
            const textInput = document.getElementById('locations-input');
            const hiddenInput = document.getElementById('hidden-locations');
            const skilltagContainer = document.getElementById('skills-container');
            const skilltextInput = document.getElementById('skills-input');
            const skillhiddenInput = document.getElementById('hidden-skills');
            const companyViewProfileCountEl = document.getElementById('companyViewProfileCount');
            const companyAppliedCount = document.getElementById('companyAppliedCount');
            let locations = [];
            let skills = [];
            
            // function showcCmpanyViewProfileCountEl(){
            //   try {
            //     const response = fetch(API_URL+'/jobseeker/profile/'+{currentUserId});
            //     if (!response.ok) {
            //             throw new Error(`Server responded with status: ${response.status}. Please ensure the Go API is running.`);
            //     }
            //     const data = response.json();
            //    companyViewProfileCountEl.textContent = data;
            //  }  catch (error) {
            //         console.error("Fetch error:", error);
            //         displayError(error.message);
            //     }
            // }
                function initializeProfileVisit() {
                
                // The API endpoint to fetch data from
                const apiUrl = 'http://localhost:8080/resume-visit/' + currentUserId;

                // Get references to the HTML elements we need to update
                const countElement = document.getElementById('companyViewProfileCount');
                const listElement = document.getElementById('companyVisitList');

                // Use the Fetch API to get the data
                fetch(apiUrl)
                    .then(response => {
                        // Check if the request was successful
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json(); // Parse the JSON from the response
                    })
                    .then(data => {
                        // Update the total view count with the number of items in the array
                        countElement.textContent = data.length;

                        // Clear any placeholder content in the list
                        listElement.innerHTML = '';

                        // Loop through each visit in the data array
                        data.forEach(visit => {
                            // Create a new list item element
                            const listItem = document.createElement('li');
                            
                            // Format the date for better readability
                            const contactDate = new Date(visit.contact_date);
                            const options = { year: 'numeric', month: 'short', day: 'numeric' };
                            const formattedDate = contactDate.toLocaleDateString('en-US', options);

                            // Set the text content for the list item
                            listItem.textContent = `${visit.company_name} viewed your profile on ${formattedDate}.`;
                            
                            // Add the new list item to the list in the HTML
                            listElement.appendChild(listItem);
                        });
                    })
                    .catch(error => {
                        // If an error occurs, log it to the console and update the card
                        console.error('Error fetching resume visits:', error);
                        listElement.innerHTML = '<li class="text-red-500">Could not load visit data.</li>';
                    });
                }
            function initializeSkillTags() {
                const initialValues = skillhiddenInput.value.trim();
                if (initialValues) {
                    const initialskills = initialValues.split(',')
                        .map(loc => loc.trim())
                        .filter(loc => loc !== '');
                    
                    initialskills.forEach(skill => {
                        skills.push(skill);
                        createSkillTag(skill);
                    });
                }
            }
            function updateHiddenskillInput() {
                updateHiddenskillInput.value = skills.join(',');
            }

            function createSkillTag(label) {
                const tag = document.createElement('div');
                tag.classList.add('tag');
                tag.innerHTML = `
                    <span>${label}</span>
                    <span class="tag-remove" data-label="${label}">&times;</span>
                `;
                skilltagContainer.insertBefore(tag, skilltextInput);
            }
            
            skilltextInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const newskill = skilltextInput.value.trim();
                    if (newskill && !skills.includes(newskill)) {
                        skills.push(newskill);
                        createSkillTag(newskill);
                        updateHiddenskillInput();
                    }
                    skilltextInput.value = '';
                }
            });

            skilltagContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('tag-remove')) {
                    const labelToRemove = e.target.dataset.label;
                    skills = skills.filter(loc => loc !== labelToRemove);
                    e.target.parentElement.remove();
                    updateHiddenskillInput();
                } else if (e.target === skilltagContainer) {
                    skilltextInput.focus();
                }
            });

            initializeSkillTags();
        
            initializeProfileVisit();
            // showcCmpanyViewProfileCountEl()
           function initializeTags() {
                const initialValues = hiddenInput.value.trim();
                if (initialValues) {
                    const initialLocations = initialValues.split(',')
                        .map(loc => loc.trim())
                        .filter(loc => loc !== '');
                    
                    initialLocations.forEach(location => {
                        locations.push(location);
                        createTag(location);
                    });
                }
            }

            
            function updateHiddenInput() {
                hiddenInput.value = locations.join(',');
            }

            function createTag(label) {
                const tag = document.createElement('div');
                tag.classList.add('tag');
                tag.innerHTML = `
                    <span>${label}</span>
                    <span class="tag-remove" data-label="${label}">&times;</span>
                `;
                tagContainer.insertBefore(tag, textInput);
            }
            
            textInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const newLocation = textInput.value.trim();
                    if (newLocation && !locations.includes(newLocation)) {
                        locations.push(newLocation);
                        createTag(newLocation);
                        updateHiddenInput();
                    }
                    textInput.value = '';
                }
            });

            tagContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('tag-remove')) {
                    const labelToRemove = e.target.dataset.label;
                    locations = locations.filter(loc => loc !== labelToRemove);
                    e.target.parentElement.remove();
                    updateHiddenInput();
                } else if (e.target === tagContainer) {
                    textInput.focus();
                }
            });

            initializeTags();

            analyzeBtn.addEventListener('click', async () => {
                // Reset UI
                loader.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
                errorContainer.classList.add('hidden');
                
                try {
                    // This should point to your local Go server's endpoint for analysis, not the resume retrieval
                    const response = await fetch('http://localhost:8080/analyze-resume', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: currentUserId })
                    });

                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}. Please ensure the Go API is running.`);
                    }

                    const data = await response.json();
                    
                    // Populate UI with data
                    displayOverallRating(data.overallRating,overallScoreEl, ratingLabelEl, progressCircle);
                    displayContactInfo(data.contactInfo, contactEmailEl, contactPhoneEl);
                    displaySkills(data.skills, skillsTableBody);

                    // Show results
                    resultsContainer.classList.remove('hidden');

                } catch (error) {
                    console.error("Fetch error:", error);
                    displayError(error.message);
                } finally {
                    loader.classList.add('hidden');
                }
            });
            
            function displayError(message) {
                errorMessage.textContent = message;
                errorContainer.classList.remove('hidden');
            }


            // Attach listeners for the profile section
            document.getElementById('toggleProfileFormBtn').addEventListener('click', () => toggleProfileForm(true));
            document.getElementById('cancelProfileUpdateBtn').addEventListener('click', () => toggleProfileForm(false));
            document.getElementById('jobSeekerProfileForm').addEventListener('submit', handleProfileUpdate);


            // --- Initialize sections ---
            await fetchUserProfile(currentUserId);
            renderProfileSection();
            updateDashboardResumeSection(currentUserId);
        }
window.loadCompanyDashboard = function() {
    
    // --- ðŸ“¢ ADVERTISEMENT SETUP ---
    // This block runs only once to create and manage the ad banners.
    (function setupAdvertisements() {
        // Exit if ads are already on the page
        if (document.getElementById('left-ads-container')) return;

        // 1. Ad Data with company/product names and multiple media types
        const adData = [
            { id: 'ad1', type: 'image', company: 'Nature Escapes', product: 'Mountain Hikes', link: 'https://example.com/ad1', mediaUrl: 'https://picsum.photos/id/1015/300/400' },
            { id: 'ad2', type: 'video', company: 'Ocean Waves', product: 'Relaxing Sounds', link: 'https://example.com/ad2', mediaUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4' },
            { id: 'ad3', type: 'image', company: 'City Life', product: 'Urban Photography', link: 'https://example.com/ad3', mediaUrl: 'https://picsum.photos/id/1025/300/400' },
            { id: 'ad4', type: 'gif', company: 'Pixel Art', product: 'Creative Designs', link: 'https://example.com/ad4', mediaUrl: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNTFqbnJ2b3E0bnhuaTJkOGVjOXhqdGlmaThoaDFoMG5ob3Rya3VqZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o7btXIEl4pvo0692g/giphy.gif' },
            { id: 'ad5', type: 'image', company: 'Vintage Co.', product: 'Classic Cars', link: 'https://example.com/ad5', mediaUrl: 'https://picsum.photos/id/106/300/400' },
            { id: 'ad6', type: 'image', company: 'Tech Hub', product: 'Latest Gadgets', link: 'https://example.com/ad6', mediaUrl: 'https://picsum.photos/id/219/300/400' },
            { id: 'ad7', type: 'video', company: 'Adventures', product: 'Explore More', link: 'https://example.com/ad7', mediaUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4' },
            { id: 'ad8', type: 'image', company: 'Artisan Cafe', product: 'Fresh Coffee', link: 'https://example.com/ad8', mediaUrl: 'https://picsum.photos/id/431/300/400' },
        ];

        // 2. Initialize or load click counters from Local Storage
        let adClicks = JSON.parse(localStorage.getItem('adClicks')) || {};
        adData.forEach(ad => {
            if (!adClicks[ad.id]) {
                adClicks[ad.id] = 0;
            }
        });
        const saveClicks = () => localStorage.setItem('adClicks', JSON.stringify(adClicks));

        // 3. Create HTML containers for the ads
        const leftContainer = document.createElement('div');
        leftContainer.id = 'left-ads-container';
        leftContainer.className = 'ad-container';

        const rightContainer = document.createElement('div');
        rightContainer.id = 'right-ads-container';
        rightContainer.className = 'ad-container';

        for (let i = 1; i <= 3; i++) {
            leftContainer.innerHTML += `<div class="ad-banner-slot" id="ad-left-${i}"></div>`;
            rightContainer.innerHTML += `<div class="ad-banner-slot" id="ad-right-${i}"></div>`;
        }

        document.body.prepend(leftContainer);
        document.body.appendChild(rightContainer);
        
        // 4. Inject CSS to support media elements and text overlays
        const adStyles = `
            body {
                background-color: #f0f2f5;
            }
            .ad-container {
                position: fixed;
                top: 0;
                bottom: 0;
                width: 160px;
                padding: 20px 0;
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                align-items: center;
                z-index: 99;
            }
            #left-ads-container { left: 20px; }
            #right-ads-container { right: 20px; }
            
            .ad-banner-slot {
                width: 150px;
                height: 200px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                cursor: pointer;
                opacity: 1;
                transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease-out;
                position: relative; /* Needed for positioning the overlay */
                overflow: hidden;   /* Hides media overflow */
                background-color: #000; /* Fallback for slow-loading media */
            }
            .ad-banner-slot:hover {
                transform: scale(1.05);
                box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            }
            .ad-media {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                object-fit: cover; /* Ensures media fills the container */
            }
            .ad-overlay {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 8px;
                color: #fff;
                background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0) 100%);
                text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
                pointer-events: none; /* Allows clicks to pass through to the parent slot */
            }
            .ad-company {
                font-size: 0.8rem;
                font-weight: bold;
                display: block;
            }
            .ad-product {
                font-size: 0.7rem;
                display: block;
            }
            #dashboardContent {
                max-width: 900px;
                margin: 0 auto;
                padding: 20px;
            }
            @media (max-width: 1280px) {
                .ad-container { display: none; }
                #dashboardContent { margin: 0 20px; }
            }
        `;
        const styleSheet = document.createElement("style");
        styleSheet.innerText = adStyles;
        document.head.appendChild(styleSheet);

        // 5. [MODIFIED] Ad Rotation Logic to ensure unique ads
        const adSlots = document.querySelectorAll('.ad-banner-slot');
        function rotateAds() {
            // Shuffle the ads to randomize them
            const shuffledAds = [...adData].sort(() => 0.5 - Math.random());
            
            adSlots.forEach((slot, index) => {
                // Fade out the slot
                slot.style.opacity = '0';
                
                // After the fade-out, build the new ad content and fade in
                setTimeout(() => {
                    // Hide slot if there are not enough unique ads to fill it
                    if (index >= shuffledAds.length) {
                        slot.style.display = 'none'; 
                        return;
                    }
                    slot.style.display = 'block';

                    // Assign a unique ad from the shuffled list for each slot
                    const ad = shuffledAds[index];
                    
                    // Clear previous content
                    slot.innerHTML = '';
                    
                    // Set data attributes for click handling
                    slot.dataset.link = ad.link;
                    slot.dataset.id = ad.id;

                    // Create media element based on type
                    let mediaElement;
                    if (ad.type === 'video') {
                        mediaElement = document.createElement('video');
                        mediaElement.autoplay = true;
                        mediaElement.muted = true;
                        mediaElement.loop = true;
                        mediaElement.playsInline = true;
                    } else { // Handles 'image' and 'gif'
                        mediaElement = document.createElement('img');
                    }
                    mediaElement.src = ad.mediaUrl;
                    mediaElement.className = 'ad-media';
                    
                    // Create text overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'ad-overlay';
                    overlay.innerHTML = `
                        <span class="ad-company">${ad.company}</span>
                        <span class="ad-product">${ad.product}</span>
                    `;

                    // Append new content and fade in
                    slot.appendChild(mediaElement);
                    slot.appendChild(overlay);
                    slot.style.opacity = '1';

                }, 300); // Delay matches the CSS transition duration
            });
        }


        // 6. Click Handling Logic
        function handleAdClick(event) {
            const adSlot = event.target.closest('.ad-banner-slot');
            if (adSlot && adSlot.dataset.link) {
                const adId = adSlot.dataset.id;
                const adLink = adSlot.dataset.link;
                
                adClicks[adId]++;
                saveClicks();
                console.log(`Ad '${adId}' clicked. Total clicks: ${adClicks[adId]}`);
                
                window.open(adLink, '_blank');
            }
        }
        
        leftContainer.addEventListener('click', handleAdClick);
        rightContainer.addEventListener('click', handleAdClick);

        // 7. Start the ad rotation
        rotateAds();
        setInterval(rotateAds, 15000);
    })();


    // --- MAIN DASHBOARD CONTENT & LOGIC (UNCHANGED) ---
    const paidText = currentIsPaidMember ? "PREMIUM: Access to full contact details." : "FREE TIER: Contact details are masked.";
    const upgradeLink = currentIsPaidMember ? '' : `<p class="text-sm text-red-500 font-bold mt-4">Upgrade your plan to view contact details.</p>`;
    const currCompany = localStorage.getItem('currentCompanyId');
    const content = `
        <div class="space-y-8">
            <div class="mx-auto space-y-8">
                <div class="p-8 bg-white rounded-2xl shadow-xl border border-indigo-400/50 space-y-6">
                    <h3 class="text-2xl font-bold text-indigo-700 border-b pb-3">Recruiter Tools</h3>
                    <p class="text-sm text-gray-600">Create job listings or browse profiles of talented jobseekers.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button id="createJobBtn" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            + Create New Job
                        </button>
                        <button id="viewListingsBtn" class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400">
                            View Active Listings
                        </button>
                        <button id="viewJobseekersBtn" class="py-2 px-4 bg-teal-500 text-white font-semibold rounded-lg shadow-md hover:bg-teal-600">
                            View Jobseeker Profiles
                        </button>
                    </div>
                </div>

                <div id="listingsContainer" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 id="listingsHeader" class="text-2xl font-bold text-indigo-700">Active Job Listings</h3>
                        <button id="hideListingsBtn" class="py-2 px-4 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600">
                            Hide
                        </button>
                    </div>
                    <div id="listingsGrid" class="space-y-4 max-h-[65vh] overflow-y-auto pr-2">
                    </div>
                </div>
            </div>

            <div id="jobFormModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
                <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-2xl font-bold text-indigo-700 border-b pb-3 mb-4">Create New Job Listing</h3>
                        <form id="newJobForm" class="space-y-4">
                            <input type="hidden" id="company_id" name="company_id" value="3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="job_title" class="block text-sm font-medium text-gray-700">Job Title</label>
                                    <input type="text" name="job_title" id="job_title" value="Backend Go Developer" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div>
                                    <label for="job_location" class="block text-sm font-medium text-gray-700">Job Location</label>
                                    <input type="text" name="job_location" id="job_location" value="Gurugram, Haryana" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                            </div>
                            <div>
                                <label for="job_description" class="block text-sm font-medium text-gray-700">Job Description</label>
                                <textarea name="job_description" id="job_description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>Developing high-performance APIs and services.</textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="number_of_openings" class="block text-sm font-medium text-gray-700">Openings</label>
                                    <input type="number" name="number_of_openings" id="number_of_openings" value="2" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div>
                                    <label for="job_type" class="block text-sm font-medium text-gray-700">Job Type</label>
                                    <select id="job_type" name="job_type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option>Full-time</option><option>Part-time</option><option>Contract</option><option>Internship</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="required_experience" class="block text-sm font-medium text-gray-700">Experience (Years)</label>
                                    <input type="text" name="required_experience" id="required_experience" value="3-5 years" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="salary_range" class="block text-sm font-medium text-gray-700">Salary Range (PA)</label>
                                    <input type="text" name="salary_range" id="salary_range" value="â‚¹20,00,000 - â‚¹30,00,000 PA" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div>
                                    <label for="required_qualifications" class="block text-sm font-medium text-gray-700">Qualifications</label>
                                    <input type="text" name="required_qualifications" id="required_qualifications" value="B.Tech in Computer Science" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                            </div>
                            <div>
                                <label for="skills_required" class="block text-sm font-medium text-gray-700">Skills Required (comma-separated)</label>
                                <input type="text" name="skills_required" id="skills_required" value="Go, PostgreSQL, Docker, gRPC" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="application_deadline" class="block text-sm font-medium text-gray-700">Application Deadline</label>
                                    <input type="datetime-local" name="application_deadline" id="application_deadline" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div>
                                    <label for="job_posting_status" class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="job_posting_status" name="job_posting_status" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option>OPEN</option><option>CLOSED</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex items-center justify-end pt-4 space-x-4 border-t mt-6">
                                <button id="cancelBtn" type="button" class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400">Cancel</button>
                                <button type="submit" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Create Job</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="editJobModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
                <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-2xl font-bold text-indigo-700 border-b pb-3 mb-4">Edit Job Listing</h3>
                        <form id="editJobForm" class="space-y-4">
                             <input type="hidden" id="edit_job_id" name="id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="edit_job_title" class="block text-sm font-medium text-gray-700">Job Title</label>
                                    <input type="text" name="job_title" id="edit_job_title" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div>
                                    <label for="edit_job_location" class="block text-sm font-medium text-gray-700">Job Location</label>
                                    <input type="text" name="job_location" id="edit_job_location" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                            </div>
                            <div>
                                <label for="edit_job_description" class="block text-sm font-medium text-gray-700">Job Description</label>
                                <textarea name="job_description" id="edit_job_description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                    <label for="edit_number_of_openings" class="block text-sm font-medium text-gray-700">Openings</label>
                                    <input type="number" name="number_of_openings" id="edit_number_of_openings" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div>
                                    <label for="edit_job_type" class="block text-sm font-medium text-gray-700">Job Type</label>
                                    <select id="edit_job_type" name="job_type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option>Full-time</option><option>Part-time</option><option>Contract</option><option>Internship</option>
                                    </select>
                                </div>
                                    <div>
                                    <label for="edit_required_experience" class="block text-sm font-medium text-gray-700">Experience (Years)</label>
                                    <input type="text" name="required_experience" id="edit_required_experience" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                            </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="edit_salary_range" class="block text-sm font-medium text-gray-700">Salary Range (PA)</label>
                                    <input type="text" name="salary_range" id="edit_salary_range" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div>
                                    <label for="edit_required_qualifications" class="block text-sm font-medium text-gray-700">Qualifications</label>
                                    <input type="text" name="required_qualifications" id="edit_required_qualifications" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                            </div>
                            <div>
                                <label for="edit_skills_required" class="block text-sm font-medium text-gray-700">Skills Required (comma-separated)</label>
                                <input type="text" name="skills_required" id="edit_skills_required" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="edit_application_deadline" class="block text-sm font-medium text-gray-700">Application Deadline</label>
                                    <input type="datetime-local" name="application_deadline" id="edit_application_deadline" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                                </div>
                                <div>
                                    <label for="edit_job_posting_status" class="block text-sm font-medium text-gray-700">Status</label>
                                        <select id="edit_job_posting_status" name="job_posting_status" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option>OPEN</option><option>CLOSED</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex items-center justify-end pt-4 space-x-4 border-t mt-6">
                                <button id="cancelEditBtn" type="button" class="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400">Cancel</button>
                                <button type="submit" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="resumeViewerModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4">
                <div class="relative mx-auto border w-full max-w-4xl h-[95vh] shadow-lg rounded-md bg-white flex flex-col">
                    <div class="flex justify-between items-center p-3 border-b mb-2">
                        <h3 id="resumeModalHeader" class="text-xl font-semibold text-gray-800">Resume Viewer</h3>
                        <button id="closeResumeModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                    </div>
                    <div class="flex-grow p-2">
                        <iframe id="resumeFrame" class="w-full h-full border-0" src=""></iframe>
                    </div>
                </div>
            </div>

            <div class="p-8 bg-white rounded-2xl shadow-xl border border-green-400/50 space-y-6">
                <h3 class="text-2xl font-bold text-green-700 border-b pb-3">Candidate Search & Matching</h3>
                <p class="text-sm text-gray-600">${paidText}</p>
                <form id="candidateSearchForm" class="space-y-4">
                    <input type="text" id="searchKeywords" placeholder="Enter required skills (e.g., Kubernetes, Python, 5 years)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3" required>
                    <button type="submit" class="w-full py-2 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
                        Search Matching Resumes (Elastic)
                    </button>
                </form>
                <div id="candidateResults" class="mt-6 space-y-4"></div>
                ${upgradeLink}
            </div>
        </div>
    `;
    document.getElementById('dashboardContent').innerHTML = content;

    // --- Get Element References ---
    const modal = document.getElementById('jobFormModal');
    const createJobBtn = document.getElementById('createJobBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const newJobForm = document.getElementById('newJobForm');
    const viewListingsBtn = document.getElementById('viewListingsBtn');
    const listingsContainer = document.getElementById('listingsContainer');
    const listingsGrid = document.getElementById('listingsGrid');
    const hideListingsBtn = document.getElementById('hideListingsBtn');
    const listingsHeader = document.getElementById('listingsHeader');
    const viewJobseekersBtn = document.getElementById('viewJobseekersBtn');
    const editModal = document.getElementById('editJobModal');
    const editJobForm = document.getElementById('editJobForm');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const resumeViewerModal = document.getElementById('resumeViewerModal');
    const closeResumeModalBtn = document.getElementById('closeResumeModalBtn');
    const resumeFrame = document.getElementById('resumeFrame');
    const resumeModalHeader = document.getElementById('resumeModalHeader');


    // --- Event Listeners for Modals ---
    createJobBtn.addEventListener('click', () => {
        const deadlineInput = document.getElementById('application_deadline');
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        now.setDate(now.getDate() + 30);
        deadlineInput.value = now.toISOString().slice(0, 16);
        modal.style.display = 'block';
    });

    cancelBtn.addEventListener('click', () => modal.style.display = 'none');
    cancelEditBtn.addEventListener('click', () => editModal.style.display = 'none');
    hideListingsBtn.addEventListener('click', () => listingsContainer.classList.add('hidden'));
    closeResumeModalBtn.addEventListener('click', () => {
        resumeViewerModal.style.display = 'none';
        resumeFrame.src = 'about:blank';
    });

    window.addEventListener('click', (event) => {
        if (event.target === modal) modal.style.display = 'none';
        if (event.target === editModal) editModal.style.display = 'none';
        if (event.target === resumeViewerModal) {
            resumeViewerModal.style.display = 'none';
            resumeFrame.src = 'about:blank';
        }
    });

    // --- Event Listener for Form Submission ---
    newJobForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(newJobForm);
        const jobData = {};
        formData.forEach((value, key) => {
            jobData[key] = key === 'number_of_openings' ? parseInt(value, 10) : value;
        });
        jobData.posting_date = new Date().toISOString();
        jobData.application_deadline = new Date(jobData.application_deadline).toISOString();
        jobData['company_id'] = localStorage.getItem('currentCompanyId');

        try {
            const response = await fetch('http://localhost:8080/job-posting', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(jobData),
            });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            await response.json();
            await updateActiveListingsCount();
            modal.style.display = 'none';
            newJobForm.reset();
            alert('New job listing created successfully!');
        } catch (error) {
            console.error('Error submitting form:', error);
            alert(`Failed to create job listing. ${error.message}`);
        }
    });

    // --- Event Listener to View Listings ---
    viewListingsBtn.addEventListener('click', async () => {
        viewListingsBtn.textContent = 'Loading...';
        viewListingsBtn.disabled = true;

        try {
            listingsHeader.textContent = 'Active Job Listings';
            const response = await fetch(`http://localhost:8080/job-posting/company/${currCompany}`);
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const jobs = await response.json();
            displayJobListings(jobs);
        } catch (error) {
            console.error('Error fetching job listings:', error);
            listingsGrid.innerHTML = `<div class="p-6 bg-red-100 text-red-700 rounded-lg">Failed to load job listings.</div>`;
        } finally {
            listingsContainer.classList.remove('hidden');
            await updateActiveListingsCount();
            viewListingsBtn.disabled = false;
        }
    });

    // --- Event Listener to View Jobseeker Profiles ---
    viewJobseekersBtn.addEventListener('click', async () => {
        const originalText = viewJobseekersBtn.textContent;
        viewJobseekersBtn.textContent = 'Loading...';
        viewJobseekersBtn.disabled = true;

        try {
            listingsHeader.textContent = 'Jobseeker Profiles';
            
            const [profileResponse, statusResponse] = await Promise.all([
                fetch('http://localhost:8080/jobseeker/profile/all'),
                fetch(`http://localhost:8080/resume-visit/company/${currCompany}`)
            ]);

            if (!profileResponse.ok) throw new Error(`Failed to fetch profiles: ${profileResponse.status}`);
            if (!statusResponse.ok) throw new Error(`Failed to fetch statuses: ${statusResponse.status}`);
            
            const profiles = await profileResponse.json();
            const contacts = await statusResponse.json();

            const contactStatusMap = contacts.reduce((map, contact) => {
                map[contact.user_id] = contact;
                return map;
            }, {});

            displayJobseekerProfiles(profiles, contactStatusMap);

        } catch (error) {
            console.error('Error fetching jobseeker data:', error);
            listingsGrid.innerHTML = `<div class="p-6 bg-red-100 text-red-700 rounded-lg">Failed to load jobseeker data.</div>`;
        } finally {
            listingsContainer.classList.remove('hidden');
            viewJobseekersBtn.textContent = originalText;
            viewJobseekersBtn.disabled = false;
        }
    });
    
    // --- Handler for status updates ---
    async function handleStatusUpdate(event) {
        const selectElement = event.target;
        const userId = selectElement.dataset.userid;
        const resumeId = selectElement.dataset.resumeid;
        const newStatus = selectElement.value;
        const companyId = localStorage.getItem('currentCompanyId');

        selectElement.disabled = true;

        try {
            const response = await fetch('http://localhost:8080/resume-visit', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: parseInt(userId, 10),
                    resume_id: parseInt(resumeId, 10),
                    company_id: parseInt(companyId, 10),
                    status: newStatus
                })
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`Failed to update status: ${errorData || response.statusText}`);
            }
            
            alert('Status updated successfully!');

        } catch (error) {
            console.error('Error updating status:', error);
            alert(error.message);
        } finally {
            selectElement.disabled = false;
        }
    }
    
    // --- Helper Functions ---
    async function updateActiveListingsCount() {
        const companyId = localStorage.getItem('currentCompanyId');
        if (!companyId) {
            viewListingsBtn.textContent = 'View Active Listings (Error)';
            return;
        }
        try {
            const response = await fetch(`http://localhost:8080/job-posting/company/${companyId}/count`);
            if (response.ok) {
                const data = await response.json();
                viewListingsBtn.textContent = `View Active Listings (${data.count})`;
            } else {
                viewListingsBtn.textContent = 'View Active Listings (Error)';
            }
        } catch (error) {
            console.error("Fetch error for count:", error);
            viewListingsBtn.textContent = 'View Active Listings (Error)';
        }
    }
    
    function displayJobseekerProfiles(profiles, contactStatusMap) {
        listingsGrid.innerHTML = ''; 

        if (!profiles || profiles.length === 0) {
            listingsGrid.innerHTML = `<div class="p-6 bg-yellow-100 text-yellow-800 rounded-lg">No jobseeker profiles found.</div>`;
            return;
        }

        profiles.forEach(profile => {
            const profileCard = document.createElement('div');
            profileCard.className = 'p-6 bg-white rounded-lg shadow-md border border-gray-200';
            
            const currentContact = contactStatusMap[profile.user_id];
            const statusOptions = ['RESUME_CHECKED', 'CONTACTED', 'PENDING', 'REJECTED', 'SELECTED'];
            let statusManagementHTML = '';

            if (currentContact) {
                statusManagementHTML = `
                    <div class="mt-4 pt-4 border-t">
                        <label for="status-select-${profile.user_id}" class="block text-sm font-medium text-gray-700 mb-1">Candidate Status:</label>
                        <select id="status-select-${profile.user_id}" 
                                data-userid="${profile.user_id}" 
                                data-resumeid="${currentContact.resume_id}" 
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            ${statusOptions.map(option => 
                                `<option value="${option}" ${option === currentContact.status ? 'selected' : ''}>
                                    ${option.replace(/_/g, ' ')}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                `;
            }
            
            profileCard.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between sm:items-center border-b pb-3 mb-3">
                    <h4 class="text-xl font-bold text-teal-800">${profile.job_title}</h4>
                    <span class="text-sm font-medium text-gray-600 bg-gray-100 py-1 px-3 rounded-full mt-2 sm:mt-0">${profile.location}</span>
                </div>
                <p class="text-gray-600 mb-4 italic">"${profile.profile_summary}"</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    <div><span class="font-semibold text-gray-800">ðŸ¢ Current Co:</span><p class="text-gray-600">${profile.current_company}</p></div>
                    <div><span class="font-semibold text-gray-800">â³ Experience:</span><p class="text-gray-600">${profile.work_ex} yrs (Overall: ${profile.overall_work_ex} yrs)</p></div>
                    <div><span class="font-semibold text-gray-800">ðŸ’° Salary (LPA):</span><p class="text-gray-600">${profile.salary_range}</p></div>
                    <div><span class="font-semibold text-gray-800">ðŸ“ Open to:</span><p class="text-gray-600">${profile.open_for_locations}</p></div>
                    <div><span class="font-semibold text-gray-800">ðŸ› ï¸ Skills:</span><p class="text-gray-600">${profile.skills}</p></div>
                    <div><span class="font-semibold text-gray-800">ðŸ’¼ Job Type:</span><p class="text-gray-600">${profile.job_type}</p></div>
                </div>
                <div class="mt-4 pt-4 border-t flex space-x-2">
                    <button id="view-resume-${profile.user_id}" data-userid="${profile.user_id}" data-profileid="${profile.id}"
                        class="py-1 px-3 bg-green-600 text-white text-sm font-semibold rounded-md shadow-md hover:bg-green-700">
                        ðŸ“„ View Resume
                    </button>
                </div>
                ${statusManagementHTML}
            `;
            listingsGrid.appendChild(profileCard);
            
            if (currentContact) {
                document.getElementById(`status-select-${profile.user_id}`).addEventListener('change', handleStatusUpdate);
            }

            document.getElementById(`view-resume-${profile.user_id}`).addEventListener('click', async (event) => {
                const button = event.currentTarget;
                button.textContent = 'Loading...';
                button.disabled = true;

                const userId = button.dataset.userid;
                const companyId = localStorage.getItem('currentCompanyId');

                if (!companyId) {
                    alert('Company ID not found. Cannot log resume visit.');
                    button.textContent = 'ðŸ“„ View Resume';
                    button.disabled = false;
                    return;
                }

                try {

                    const resumeResponse = await fetch(`http://localhost:8080/resume/${userId}`);
                    if (!resumeResponse.ok) throw new Error(`Could not fetch resume. Status: ${resumeResponse.status}`);
                    
                    const resumeDetails = await resumeResponse.json();

                    if (resumeDetails.download_url) {
                        const resumeUrl = 'http://localhost:8080' + resumeDetails.download_url;
                        resumeModalHeader.textContent = `Viewing Resume: ${resumeDetails.filename || 'N/A'}`;
                        resumeFrame.src = resumeUrl;
                        resumeViewerModal.style.display = 'flex';
                    } else {
                        throw new Error("Download URL not found in the response.");
                    }

                    fetch('http://localhost:8080/resume-visit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: parseInt(userId, 10),
                            resume_id: parseInt(resumeDetails.id, 10),
                            company_id: parseInt(companyId, 10)
                        })
                    }).then(res => {
                        if (res.ok) {
                            viewJobseekersBtn.click();
                        }
                    }).catch(logError => console.error("Failed to log resume visit:", logError));
                    
                } catch (error) {
                    console.error('Error viewing resume:', error);
                    alert(`Failed to load resume: ${error.message}`);
                } finally {
                    button.textContent = 'ðŸ“„ View Resume';
                    button.disabled = false;
                }
            });
        });
    }

    function displayJobListings(jobs) {
        listingsGrid.innerHTML = '';

        if (!jobs || jobs.length === 0) {
            listingsGrid.innerHTML = `<div class="p-6 bg-yellow-100 text-yellow-800 rounded-lg">No active listings found.</div>`;
            return;
        }

        jobs.forEach(job => {
            const deadline = new Date(job.application_deadline).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const jobCard = document.createElement('div');
            jobCard.className = 'p-6 bg-white rounded-lg shadow-md border border-gray-200';
            jobCard.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between sm:items-center border-b pb-3 mb-3">
                    <h4 class="text-xl font-bold text-indigo-800">${job.job_title}</h4>
                    <span class="text-sm font-medium ${job.job_posting_status === 'OPEN' ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100'} py-1 px-3 rounded-full mt-2 sm:mt-0">${job.job_posting_status}</span>
                </div>
                <p class="text-gray-600 mb-4">${job.job_description}</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    <div><span class="font-semibold text-gray-800">ðŸ“ Location:</span><p class="text-gray-600">${job.job_location}</p></div>
                    <div><span class="font-semibold text-gray-800">ðŸ’¼ Type:</span><p class="text-gray-600">${job.job_type}</p></div>
                    <div><span class="font-semibold text-gray-800">ðŸ’° Salary:</span><p class="text-gray-600">${job.salary_range}</p></div>
                    <div><span class="font-semibold text-gray-800">ðŸŽ“ Experience:</span><p class="text-gray-600">${job.required_experience}</p></div>
                    <div><span class="font-semibold text-gray-800">ðŸ› ï¸ Skills:</span><p class="text-gray-600">${job.skills_required}</p></div>
                    <div><span class="font-semibold text-gray-800">ðŸ“… Deadline:</span><p class="text-gray-600">${deadline}</p></div>
                </div>
                <div class="mt-4 pt-4 border-t flex space-x-2">
                    <button class="py-1 px-3 bg-blue-600 text-white text-sm font-semibold rounded-md shadow-md hover:bg-blue-700" id='jobpostingedit${job.id}'>Edit</button>
                    <button class="py-1 px-3 bg-red-600 text-white text-sm font-semibold rounded-md shadow-md hover:bg-red-700" id='jobpostingdelete${job.id}'>Delete</button>
                </div>
            `;
            listingsGrid.appendChild(jobCard);
            
            document.getElementById(`jobpostingedit${job.id}`).addEventListener('click', () => openEditModal(job));
            document.getElementById(`jobpostingdelete${job.id}`).addEventListener('click', async () => {
                if (!confirm('Are you sure you want to delete this job posting?')) return;
                try {
                    const response = await fetch(`http://localhost:8080/job-posting/${job.id}`, { method: 'DELETE' });
                    if (response.ok) {
                        alert('Job posting deleted successfully!');
                        jobCard.remove(); 
                        updateActiveListingsCount();
                    } else {
                        alert('Failed to delete job posting.');
                    }
                } catch (error) {
                    alert('An error occurred. Please check your network connection.');
                }
            });
        });
    }

    function openEditModal(job) {
        document.getElementById('edit_job_id').value = job.id;
        document.getElementById('edit_job_title').value = job.job_title;
        document.getElementById('edit_job_location').value = job.job_location;
        document.getElementById('edit_job_description').value = job.job_description;
        document.getElementById('edit_number_of_openings').value = job.number_of_openings;
        document.getElementById('edit_job_type').value = job.job_type;
        document.getElementById('edit_required_experience').value = job.required_experience;
        document.getElementById('edit_salary_range').value = job.salary_range;
        document.getElementById('edit_required_qualifications').value = job.required_qualifications;
        document.getElementById('edit_skills_required').value = job.skills_required;
        const deadline = new Date(job.application_deadline);
        deadline.setMinutes(deadline.getMinutes() - deadline.getTimezoneOffset());
        document.getElementById('edit_application_deadline').value = deadline.toISOString().slice(0, 16);
        document.getElementById('edit_job_posting_status').value = job.job_posting_status;
        editModal.style.display = 'block';
    }

    editJobForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(editJobForm);
        const jobData = {};
        formData.forEach((value, key) => {
            jobData[key] = key === 'number_of_openings' ? parseInt(value, 10) : value;
        });
        jobData.application_deadline = new Date(jobData.application_deadline).toISOString();
        jobData['company_id'] = parseInt(localStorage.getItem('currentCompanyId'));

        try {
            const response = await fetch(`http://localhost:8080/job-posting`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(jobData),
            });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            editModal.style.display = 'none';
            alert('Job listing updated successfully!');
            viewListingsBtn.click();
        } catch (error) {
            console.error('Error updating form:', error);
            alert(`Failed to update job listing. ${error.message}`);
        }
    });

    updateActiveListingsCount();
};
        window.loadAdvertiserDashboard = function() {
            const content = `
                <div class="p-8 bg-white rounded-2xl shadow-xl border border-purple-400/50 space-y-6">
                    <h3 class="text-2xl font-bold text-purple-700 border-b pb-3">Campaign Management Console</h3>
                    <p class="text-sm text-gray-600">Manage ad placements targeting Job Seekers and Companies.</p>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="p-4 bg-purple-50 rounded-lg border">
                            <p class="text-4xl font-extrabold text-purple-600">5</p>
                            <p class="text-sm text-gray-700">Active Campaigns</p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg border">
                            <p class="text-4xl font-extrabold text-purple-600">8.2%</p>
                            <p class="text-sm text-gray-700">Average CTR</p>
                        </div>
                    </div>
                    <button class="w-full py-2 px-4 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700">
                        View Analytics & Reports
                    </button>
                </div>
            `;
            document.getElementById('dashboardContent').innerHTML = content;
        }


        // Initial setup run
        document.addEventListener('DOMContentLoaded', checkAuth);

        function displayOverallRating(rating,overallScoreEl,ratingLabelEl,progressCircle) {
                const percentage = Math.round(rating.scorePercentage);
                overallScoreEl.textContent = `${percentage}%`;
                ratingLabelEl.textContent = rating.ratingLabel;
                const offset = 100 - percentage;
                progressCircle.style.strokeDashoffset = offset;
        }

        function displayContactInfo(contact,contactEmailEl,contactPhoneEl) {
                contactEmailEl.textContent = contact.email || 'Not found';
                contactPhoneEl.textContent = contact.phone || 'Not found';
        }

            function displaySkills(skills,skillsTableBody) {
                skillsTableBody.innerHTML = ''; // Clear previous results
                skills.forEach(skill => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 transition duration-300 ease-in-out hover:bg-gray-700/50';
                    row.innerHTML = `
                        <td class="whitespace-nowrap px-4 py-3 font-medium">${skill.skill}</td>
                        <td class="whitespace-nowrap px-4 py-3 text-center">${skill.mentions}</td>
                        <td class="whitespace-nowrap px-4 py-3">${skill.rating}</td>
                    `;
                    skillsTableBody.appendChild(row);
                });
            }
    </script>
</body>
</html>

